{% extends 'voting/header.html' %}

{% block content %}
{% include "voting/includes/status.html" %}

{% load static %}
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script src="{% static 'js/myVotes.js' %}" defer></script>
<hr>
<br>


<h1>VotingPage</h1>

<form id="search">
  <label>go to number:<input id="number" name="number"></label>
  <input type="submit" value="Submit">
</form>

{% comment %} iterate over all creations in the formList {% endcomment %}
{% for formListItems in formList %}
  <h2>({{formListItems.creation.id}}) {{ formListItems.creation.name }} | number: {{formListItems.creation.number}}</h2>
  
  <img src="{{ formListItems.creation.image.url }}" alt="..."  width="250" height="250">
  {% comment %} iterate over the carehoryforms dictionary (so all data for one creation: forms and vote per category) {% endcomment %}
  {% for key, value in formListItems.categoryForms.items %}
    <h3 id="creation_{{formListItems.creation.number}}" class="{{key}}">{{key}}</h3>
 
    <form method="post" novalidate #oninput="submit()" class="formtag">
      {% csrf_token %}  

      <div class="voteform" id="voteform">
          {% for radio in value.form.vote %}
            <input name="vote"
            type="radio" 
            id="crea_{{formListItems.creation.id}}_cat_{{key}}_{{radio.id_for_label}}"  
            value="{{ forloop.counter }}"
            {% if forloop.counter == value.vote %}checked{% endif %}>
            <label for="crea_{{formListItems.creation.id}}_cat_{{key}}_{{radio.id_for_label}}">{{ radio.choice_label }}</label>
            {% endfor %}
            <div>
              <input type="hidden" name="creationId" value="{{ formListItems.creation.id }}">
            </div>
            (id: {{ formListItems.creation.id }} - catVote: {{value.vote}})
            <div>
              <input type="hidden" name="category" value="{{key}}">
            </div>
          </div>
          {% comment %} <button type="submit">Submit</button> {% endcomment %}
    </form> 
    {% endfor %}
{% endfor %}


<script>

  // star submission


  function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            // Does this cookie string begin with the name we want?
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}


function csrfSafeMethod(method) {
  // these HTTP methods do not require CSRF protection
  return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}

$.ajaxSetup({
  beforeSend: function(xhr, settings) {
      csrftoken = getCookie('csrftoken');
      if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
          xhr.setRequestHeader("X-CSRFToken", csrftoken);
      }
  }
});


// console.log(document.getElementsByTagName("label")[1]); {%  document.getElementsByTagName("label")[0].addEventListener("click", prevent);

document.querySelectorAll('label').forEach(item => {
  item.addEventListener('click', event => {
      // console.log("clicked!");
      // event.preventDefault();

      // var csrfToken = document.getElementsByName("csrfmiddlewaretoken")[0].value;
      var label = event.target;
      var forAttribute = label.getAttribute('for');
      var input = document.getElementById(forAttribute);
      var value = input.value;
      var category;
      var creationId;
      var csrftoken = getCookie('csrftoken');
      var form = input.closest('form');
      
      console.log("form: ", form);
      console.log("label: ", label);
      console.log("input: ", input);
      console.log("value: ", value);
      console.log("csrfToken: ", csrftoken);
      console.log("serializedForm: ", $(form).serialize());
      

      $.ajax({
          type: "POST",
          url: "{% url 'voting:myvotes' %}",
          headers: {
              "Content-Type": "application/json",
              "HTTP_GROUP_NAME": "groups_name",
          },
          data: {
            "csrfmiddlewaretoken": csrftoken,
            "form": $(form).serialize(),
            // "creationId" : 1,
            // "vote": 1,
          },
          success: function (data) {
              console.log("success");
              //console.log(data);
          },
          failure: function (data) {
              console.log("failure");
              console.log(data);
          },
      });
      console.log('function ran.')
  });

})

</script>
{% endblock %}